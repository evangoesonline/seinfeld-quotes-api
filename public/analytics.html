<!DOCTYPE html>
<html lang="en">

<head>
    <title>Character Quote Statistics</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/public/images/favicon.ico">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;700&family=Roboto:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        /* Add your custom styles here */
        .bar {
            fill: steelblue;
        }

        .bar:hover {
            fill: orange;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>

<body>
    <div>
        <h1>Analytics</h1>
    </div>
    <div id="chart-container"></div>

    <script>
        // Fetch data from your API
        async function fetchData() {
            try {
                const response = await fetch('/api/quotes');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Function to create the chart
        async function createChart() {
            const data = await fetchData();

            // Filter and process data to get count for main authors and others
            const filteredData = data.filter(quote => ['George', 'Elaine', 'Jerry', 'Kramer'].includes(quote.author));
            const countByAuthor = filteredData.reduce((acc, quote) => {
                const author = ['George', 'Elaine', 'Jerry', 'Kramer'].includes(quote.author) ? quote.author : 'Other';
                acc[author] = (acc[author] || 0) + 1;
                return acc;
            }, {});

            // Count for "Other" category
            const otherCount = data.length - Object.values(countByAuthor).reduce((acc, count) => acc + count, 0);

            // Convert countByAuthor object to an array
            const dataArray = Object.keys(countByAuthor).map(author => ({
                author,
                count: countByAuthor[author]
            }));

            // Add "Other" category to the array
            dataArray.push({ author: 'Other', count: otherCount });

            // Set up SVG container dimensions
            const svgWidth = 600;
            const svgHeight = 400;
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            // Create SVG container
            const svg = d3.select('#chart-container').append('svg')
                .attr('width', svgWidth)
                .attr('height', svgHeight)
                .append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            // Create X and Y scales
            const xScale = d3.scaleBand().range([0, width]).padding(0.1);
            const yScale = d3.scaleLinear().range([height, 0]);

            // Assign data to scales
            xScale.domain(dataArray.map(d => d.author));
            yScale.domain([0, d3.max(dataArray, d => d.count)]);

            // Create bars
            svg.selectAll('.bar')
                .data(dataArray)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.author))
                .attr('width', xScale.bandwidth())
                .attr('y', d => yScale(d.count))
                .attr('height', d => height - yScale(d.count))
                .on('mouseover', handleMouseOver)
                .on('mouseout', handleMouseOut);

            // Create X-axis
            svg.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(xScale));

            // Create Y-axis
            svg.append('g')
                .call(d3.axisLeft(yScale));

            // Add labels
            svg.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.top + 10})`)
                .style('text-anchor', 'middle')
                .text('Author');

            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Quote Count');

            // Tooltip
            const tooltip = d3.select('#chart-container').append('div')
                .attr('class', 'tooltip');

            function handleMouseOver(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style('opacity', 0.9);
                tooltip.html(`${d.author}: ${d.count} quotes`)
                    .style('left', `${event.pageX}px`)
                    .style('top', `${event.pageY - 28}px`);
            }

            function handleMouseOut() {
                tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            }
        }

        // Call the function to create the chart
        createChart();
    </script>
</body>

</html>